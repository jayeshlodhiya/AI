<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    :root {
        --bg: #f4f6f8;
        --panel: #ffffff;
        --muted: #8a9099;
        --text: #0f172a;
        --primary: #2563eb;
        --green: #059669;
        --purple: #7c3aed;
        --border: #e5e7eb;
        --hot: #fecaca;
        --warm: #fde68a;
        --cold: #bfdbfe;
        --chip: #eef2ff;
        --radius: 16px;
        --shadow: 0 6px 18px rgba(2,6,23,.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
        margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--text); background: var(--bg);
    }
    a { color: inherit; text-decoration: none; }
    .app {
        display: grid;
        grid-template-columns: 260px 1fr;   /* no third column */
        grid-template-rows: 64px 1fr;
        grid-template-areas:
        "sidebar topbar"
        "sidebar main";
        height: 100vh;
        overflow: hidden;
    }

    /* Sidebar */
    .sidebar { grid-area: sidebar; background: var(--panel); padding: 18px; border-right: 1px solid var(--border); box-shadow: var(--shadow); z-index: 2; }
    .brand { font-weight: 800; letter-spacing:.2px; margin: 4px 0 18px; }
    .nav { list-style: none; padding: 0; margin: 0; }
    .nav li { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 12px; color:#1f2937; cursor: pointer; transition: all 0.2s ease; }
    .nav li.active, .nav li:hover { background: #f1f5ff; color: var(--primary); transform: translateX(4px); }
    .hamburger { display:none; border:0; background: transparent; font-size: 22px; }

    /* Topbar */
    .topbar { grid-area: topbar; display:flex; align-items:center; gap:12px; padding: 12px 16px; background: var(--panel); border-bottom: 1px solid var(--border); position: sticky; top:0; z-index:1; }
    .search { display:flex; align-items:center; gap:10px; background:#f8fafc; padding: 10px 14px; border:1px solid var(--border); border-radius: 12px; width: 100%; max-width: 740px; }
    .search input { flex:1; border:0; outline: none; background: transparent; font-size: 15px; }
    .chip { background: var(--chip); color:#3730a3; padding:6px 10px; border-radius: 999px; font-size: 12px; font-weight:600; }

    /* Main */
    .main {
        grid-area: main;
        overflow: auto;
        padding: 18px;
        height: 100%;
    }
    .grid { display:grid; grid-template-columns: 2fr 1fr; gap: 18px; }
    .card { background: var(--panel); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card .header { padding: 14px 16px; border-bottom:1px solid var(--border); font-weight:700; }
    .card .body { padding: 14px 16px; }

    /* Lead scoring summary */
    .score-row { display:flex; gap: 14px; }
    .score { flex:1; padding: 14px; border-radius: 14px; display:flex; align-items:center; justify-content: space-between; font-weight: 700; }
    .score small { font-weight: 600; color:#334155; }
    .score.hot { background: var(--hot); }
    .score.warm { background: var(--warm); }
    .score.cold { background: var(--cold); }

    /* Table */
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 12px 10px; border-bottom: 1px solid var(--border);}
    thead th { font-size: 13px; color:#6b7280; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; }
    tbody tr:hover { background:#f9fafb; }
    .badge { padding:4px 10px; border-radius: 999px; font-weight:700; font-size: 12px; }
    .badge.hot { background: #fee2e2; color: #b91c1c; }
    .badge.warm { background: #fef3c7; color: #b45309; }
    .badge.cold { background: #dbeafe; color: #1d4ed8; }
    .badge.low { background: #fee2e2; color: #b91c1c; }
    .badge.medium { background: #fef3c7; color: #b45309; }
    .badge.in-stock { background: #dbeafe; color: #1d4ed8; }
    .badge.high { background: #fecaca; color: #dc2626; }

    /* Quick actions */
    .actions { display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .btn { border:0; padding: 12px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: var(--shadow); display:flex; align-items:center; justify-content:center; gap:8px; }
    .btn.primary { background: var(--primary); color:white; }
    .btn.green { background: var(--green); color:white; }
    .btn.purple { background: var(--purple); color:white; }
    .btn:active { transform: translateY(1px); }

    /* Right panel - Assistant */
    .right { grid-area: right; background: var(--panel); border-left: 1px solid var(--border); box-shadow: var(--shadow); display:flex; flex-direction: column; }
    .assistant { display:flex; flex-direction: column; height: 100%; }
    .chat { flex:1; overflow: auto; padding: 16px; }
    .msg { max-width: 85%; padding: 10px 12px; border-radius: 12px; margin: 6px 0; display:inline-flex; align-items:flex-start; line-height:1.35; white-space:pre-wrap; }
    .msg.user { background: #e2e8f0; align-self:flex-end; }
    .msg.ai { background: #e0ebff; color:#0c3b8a; }
    .composer { display:flex; gap:8px; padding: 12px; border-top:1px solid var(--border); align-items:center; }
    .composer input { flex:1; border:1px solid var(--border); border-radius: 12px; padding: 10px 12px; }
    .toggle { display:flex; align-items:center; gap:8px; font-size:12px; color:#475569; user-select:none; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(15,23,42,.35); display:none; align-items:center; justify-content:center; padding: 18px; }
    .modal .dialog { background: var(--panel); border-radius: var(--radius); width: 100%; max-width: 460px; box-shadow: var(--shadow); }
    .modal .dialog .header { padding: 14px 16px; border-bottom:1px solid var(--border); font-weight: 800; }
    .modal .dialog .body { padding: 16px; display: grid; gap: 12px; }
    .modal .dialog .footer { padding: 14px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; }

    /* Content Sections */
    .content-section { display: none; }
    .content-section.active { display: block; }
    .content-section .card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .content-section .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(2,6,23,0.12); }
    .content-section table { border-radius: 8px; overflow: hidden; }
    .content-section tbody tr { transition: background-color 0.2s ease; }
    .content-section tbody tr:hover { background-color: #f8fafc; }
    .content-section .btn { transition: all 0.2s ease; }
    .content-section .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .content-section input[type="file"] { cursor: pointer; }
    .content-section .file-upload-area { transition: all 0.2s ease; }
    .content-section .file-upload-area:hover { border-color: var(--primary); background: #f8fafc; }
    .content-section .file-upload-area.dragover { border-color: var(--primary); background: #e0ebff; }
    .content-section #documentStats > div { transition: all 0.2s ease; }
    .content-section #documentStats > div:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

    /* Responsive */
    @media (max-width: 1100px) {
        .app { grid-template-columns: 220px 1fr; grid-template-areas:
        "sidebar topbar"
        "sidebar main";
        }
        .right { display:none; }
    }
    @media (max-width: 840px) {
        .app { grid-template-columns: 1fr; grid-template-rows: 56px auto; grid-template-areas:
        "topbar"
        "main"; }
        .sidebar { position: fixed; inset: 0 auto 0 0; width: 280px; transform: translateX(-100%); transition: transform .25s ease; }
        .sidebar.open { transform: translateX(0); }
        .hamburger { display:block; }
        .grid { grid-template-columns: 1fr; }
        .actions { grid-template-columns: 1fr; }
    }
    mark { background: #fff3b0; padding:0 2px; border-radius:2px; }
    /* typing / thinking indicator */
    .spinner {
        width: 12px; height: 12px;
        border: 2px solid #93c5fd;          /* light blue */
        border-top-color: transparent;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .thinking { display: inline-flex; align-items: center; gap: 4px; }
    /* Call Agents card should stretch, and iframe should fill it */
    #callAgentsSection {
        height: 100%;
    }

    /* Card takes full height */
    #callAgentsSection .card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    /* Body expands under header */
    #callAgentsSection .card .body {
        flex: 1;
        display: flex;
        padding: 0;
        overflow: hidden; /* remove scrollbars around iframe */
    }

    /* Iframe stretches completely */
    #callAgentsFrame {
        width: 100%;
        height: 100%;
        border: 0;
        border-radius: 0 0 var(--radius) var(--radius);
    }
    /* Sticky Notes */
    #actionNotesDock {
        position: fixed; right: 12px; bottom: 12px; width: 360px; max-height: 60vh; overflow:auto;
        display:none; z-index: 50;
    }
    .note {
        background: #fffad1; border: 1px solid #f59e0b; color:#4b5563;
        border-radius: 10px; padding: 10px 10px 12px; margin-top: 10px;
        box-shadow: 0 6px 18px rgba(2,6,23,.12); position: relative;
    }
    .note .tag { font-size: 11px; font-weight: 800; color:#92400e; background:#fde68a; padding:2px 6px; border-radius:999px; }
    .note .title { font-weight: 800; margin: 6px 0 4px; color:#78350f; }
    .note .meta { font-size: 12px; color:#6b7280; }
    .note .btns { display:flex; gap:8px; margin-top:10px; }
    .note .btn-ghost { background:#fff; border:1px solid #e5e7eb; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .note .btn-primary { background:#2563eb; color:#fff; border:0; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .note .done { color:#059669; font-weight:700; }
    #actionBell {
        position: fixed; right: 12px; bottom: 12px; z-index: 51; display:none;
        background:#111827; color:#fff; border:0; border-radius:999px; padding:10px 12px; box-shadow: var(--shadow);
    }





    /* Promotions sizing */
    #promotionsSection { height: 100%; }
    #promotionsSection .card { display:flex; flex-direction:column; height:100%; min-height:70vh; }
    #promotionsSection .card .body { flex:1; display:flex; padding:0; overflow:hidden; }
    #promotionsFrame { width:100%; height:100%; border:0; border-radius:0 0 var(--radius) var(--radius); }
    #micBtn.listening { background:#fee2e2; color:#b91c1c; }

    #promotionsSection { height: 100%; }
    #promotionsSection .card { display:flex; flex-direction:column; height:100%; min-height:70vh; }
    #promotionsSection .card .body { flex:1; display:flex; padding:0; overflow:hidden; }
    #promotionsFrame { width:100%; height:100%; border:0; border-radius:0 0 var(--radius) var(--radius); }
    #promotionsSection { height: 100%; }
    #promotionsSection .card { display:flex; flex-direction:column; height:100%; min-height:70vh; }
    #promotionsSection .card .body { flex:1; display:flex; padding:0; overflow:hidden; }
    #promotionsFrame { width:100%; height:100%; border:0; border-radius:0 0 var(--radius) var(--radius); }
    #micBtn.listening { background:#fee2e2; color:#b91c1c; }

    #chatSection { height: 100%; }
    #chatSection .card { display:flex; flex-direction:column; height:100%; min-height:70vh; }
    #chatSection .card .body { flex:1; display:flex; padding:0; overflow:hidden; }
    #chatFrame { width:100%; height:100%; border:0; border-radius:0 0 var(--radius) var(--radius); }




    #documentDetailsSection { height: 100%; }
    #documentDetailsSection .card { display:flex; flex-direction:column; height:100%; min-height:70vh; }
    #documentDetailsSection .card .body { flex:1; display:flex; padding:0; overflow:hidden; }
    #documentDetailsFrame { width:100%; height:100%; border:0; border-radius:0 0 var(--radius) var(--radius); }
    #micBtn.listening { background:#fee2e2; color:#b91c1c; }

    #imagePromotionsSection { height: 100%; }
    #imagePromotionsSection .card { display:flex; flex-direction:column; height:100%; min-height:70vh; }
    #imagePromotionsSection .card .body { flex:1; display:flex; padding:0; overflow:hidden; }
    #imagePromotionsFrame { width:100%; height:100%; border:0; border-radius:0 0 var(--radius) var(--radius); }

    .logout-btn {
        margin-left: auto;              /* pushes it to the extreme right */
        padding: 8px 16px;
        font-size: 14px;
        border-radius: var(--radius);
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        box-shadow: var(--shadow);
    }
    .logout-btn:hover {
        filter: brightness(1.05);
        transform: translateY(-1px);
    }
</style>
<body>
<div id="chatSection" class="content-section">
    <section class="assistant">
        <div class="header" style="padding:14px 16px; border-bottom:1px solid var(--border); font-weight: 800;">AI Assistant
            <select id="voiceLang" title="Language" style="border:1px solid var(--border); border-radius:10px; padding:8px;">
                <option value="hi-IN">Hindi (hi-IN)</option>
                <option value="en-US">English (en-US)</option>
            </select>
        </div>
        <div class="chat" id="chat">
            <div class="msg ai">Hello! Ask me anything from your uploaded documents.</div>
        </div>
        <div class="composer">

            <input id="chatInput" placeholder="Ask AI… e.g., 2BHK in Wakad under 80L or ?payment schedule" />
            <label class="toggle" hidden="hidden"><input type="checkbox" hidden="hidden" checked="checked" id="searchModeToggle"></label>

            <button class="btn" id="micBtn" title="Speak" onclick="toggleVoice()" style="min-width:44px;">🎙️</button>
            <button class="btn primary" onclick="sendChat()">Send</button>
        </div>
    </section>
</div>
</body>
<script src="/common.js"></script>
<script>
    async function sendChat() {
        const input = document.getElementById('chatInput');
        const text = (input.value || '').trim();
        appendMsg('user', text);
        //if(!text) return;
        //  const reply = aiReply(text);
        // appendMsg('ai', reply);
        // speak(reply, getLang());
        input.value='';
        const thinking = showThinking('Looking up');
        const searchToggle = document.getElementById('searchModeToggle');
        const explicitSearch = searchToggle && searchToggle.checked;
        const prefixSearch = text.startsWith('?');
        if (explicitSearch || prefixSearch) {
            const q = prefixSearch ? text.slice(1).trim() : text;
            try {
                const data = await callRagSearch(
                    q,
                    window.currentTenantId || '',
                    window.currentType || '',
                    window.currentDocType || '',
                    window.currentDocId || '',
                    10
                );
                //   console.log("Data : "+JSON.stringify(data));
                // alert("Data : "+data.toString());
                const html = renderRagResults(data, text);
                resolveThinking(thinking, html);
                // appendMsg('ai', html, true);
            } catch (e) {
                //  appendMsg('ai', `Search error: ${e.message}`);
                removeThinking(thinking, `Error: ${err.message || 'failed to fetch'}`);
            }
            return;
        }

        // Fallback to demo property chat
        // setTimeout(()=> appendMsg('ai', aiReply(text)), 250);
    }

    function aiReply(q) {
        const { bhk, maxPrice, cityLike } = parseQuery(q);
        const found = properties.filter(p =>
            (!bhk || p.bhk===bhk) && (!maxPrice || p.price<=maxPrice) && (!cityLike || (p.city+" "+p.area).toLowerCase().includes(cityLike))
        );
        if(found.length) {
            const list = found.slice(0,5).map(p=>`${p.project} • ${p.bhk}BHK • ₹${p.price}L • ${p.area}`).join('\n- ');
            return `I found ${found.length} matching units:\n- ${list}\nShall I draft a WhatsApp with the top 2?`;
        }
        if(/draft|whatsapp|message/i.test(q)) {
            const lead = selectedLeadId ? leads.find(l=>l.id===selectedLeadId) : leads[0];
            return `Draft: Hi ${lead.name.split(' ')[0]}, sharing 2-3 options that match your budget. Site visits available this weekend. Reply with a suitable time.`;
        }
        return 'You can ask things like: "3BHK under 1Cr in Hinjewadi" or type "?payment schedule" to search your docs.';
    }

    function parseQuery(q) {
        const bhkMatch = q.match(/(\d)\s*bhk/i);
        const bhk = bhkMatch ? parseInt(bhkMatch[1]) : null;
        const priceMatch = q.match(/(?:₹\s*)?(\d+(?:\.\d+)?)\s*(cr|crore|crs|l|lac|lakh|lakhs)?/i);
        let maxPrice = null;
        if(priceMatch) {
            const num = parseFloat(priceMatch[1]);
            const unit = (priceMatch[2]||'l').toLowerCase();
            maxPrice = /cr|crore|crs/.test(unit) ? Math.round(num*100) : Math.round(num);
        }
        const loc = q.match(/in\s+([a-z\s]+)/i);
        const cityLike = loc ? loc[1].trim().toLowerCase() : null;
        return { bhk, maxPrice, cityLike };
    }

</script>
</html>